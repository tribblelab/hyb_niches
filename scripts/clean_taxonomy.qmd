---
title: "clean_taxonomy"
output: html_document
date: "2026-02-04"
---

# clean taxonomy: pull taxa names & build dict of synonyms

## load packages

```{julia}
using CSV, DataFrames
using JLD2
```

## load in taxa list df

We're only focusing on clade 1 (south) + 2b (central-northish), so let's filter down to that clade.

```{julia}
taxa_traits = DataFrame(CSV.File("data/SupTable4-TraitsSpecies.csv"))
#clean up column names - change from all caps to lowercase
rename!(lowercase, taxa_traits)
#remove spaces
rename!(x -> replace(x, ' ' => '_'), taxa_traits)
filter!(:clade => x -> x == "1" || x == "2b", taxa_traits)
```

```{julia}
rename!(taxa_traits, Dict(:species => "scientificName"))
scientificName = replace.(taxa_traits.scientificName, "C. " => "Calceolaria ")
taxa_traits.scientificName = scientificName
#make a specificEpithet col
specificEpithet      = [split(taxa, " ")[2] for taxa in scientificName]
#make an infraspecificEpithet col (splitting on var. or subsp.)
infraspecificEpithet = Vector{Union{String,Missing}}()
for taxa in scientificName
    parts = split(taxa, " ")
    if length(parts) >= 4
        push!(infraspecificEpithet, parts[4])
    else
        push!(infraspecificEpithet, missing)
    end
end

insertcols!(taxa_traits, 2, :specificEpithet => specificEpithet)
insertcols!(taxa_traits, 3, :infraspecificEpithet => infraspecificEpithet)
```

## load in powo checklist

I ran a Kew / Plants of the World Online checklist for Calceolaria species at the botanical country level
on 2026-02-04, using native/introduced taxa.

```{julia}
lines = readlines("data/powochecklist.txt")
#pull lines starting from valid species (skipping headers)
subset = lines[9:1110]
#join back into a single string
text = join(subset, "\n")
#split on one or more empty lines
blocks = split(text, r"\n\s*\n+")
```

### compare names from anahí with powo valid names

```{julia}
#define regex pattern just to pull full name before species authority
pat = Regex(
    "^(.+?)\\s+(?=\\(|[A-Z])",
    "m"
)

validnames = String[]
#grab valid names and add to this vector
for block in blocks
    push!(validnames, strip(match(pat, block)[1]))
end

discrepancies = String[]
for name in scientificName
    if name ∉ validnames
        push!(discrepancies, name)
    end
end

discrepancies
```

### reconcile discrepancies with powo

1.  "Calceolaria ascendens subsp. exigua” —> Kew says this is a synonym for "Calceolaria ascendens subsp. glandulifera"
>> This one is C. ascendens glandulifera
we already have C. ascendens glandulifera in the df, so let's delete this line.

```{julia}
#delete this entry from df
deleteat!(taxa_traits, findall(==("Calceolaria ascendens subsp. exigua"), taxa_traits.scientificName))
```

2.  "Calceolaria petiolaris” —> Kew says this is a synonym for “C. petioalaris"
>> You're right. This is a typo. It is C. petioalaris

```{julia}
#replace petiolaris with "petioalaris"
replace!(taxa_traits.scientificName, "Calceolaria petiolaris" => "Calceolaria petioalaris")
replace!(taxa_traits.specificEpithet, "petiolaris" => "petioalaris")
```

3.  "Calceolaria corymbosa subsp. montana” —> Kew says this is a synonym for "Calceolaria mollissima"
>> The right species to use here is C. corymbosa montana (mollissima is an old name)

instead of changing the dataframe or dictionary, I'll just add an if statement to the synonym matching with the POWO checklist below.

4.  "Calceolaria crenatifolia”  —> Kew doesn’t have anything for “crenatifolia”, but they do have “crenatiflora” accepted
>> Another typo. This is C. crenatiflora indeed.

```{julia}
#replace crenatifolia with "crenatiflora"
replace!(taxa_traits.scientificName, "Calceolaria crenatifolia" => "Calceolaria crenatiflora")
replace!(taxa_traits.specificEpithet, "crenatifolia" => "crenatiflora")
```

5.  "Calceolaria corymbosa subsp. santiagana” —> I think you have a typo, should be "santiagina"
>> Another typo. This is C. corymbosa santiagina (with an "i")

```{julia}
#replace santiagana with "santiagina"
replace!(taxa_traits.scientificName, "Calceolaria corymbosa subsp. santiagana" => "Calceolaria corymbosa subsp. santiagina")
replace!(taxa_traits.infraspecificEpithet, "santiagana" => "santiagina")
```

let's initialize dictionary of valid names to synonyms for just the taxa we want:

```{julia}
synonymdict = Dict{String, Vector{Tuple{String, Union{String, Missing}}}}()
for name in scientificName
    synonymdict[name] = Tuple{String, Union{String, Missing}}[]
end
```

6.  "Calceolaria dentata subsp. cummingiana” —> Kew has one m in “cumingiana” but on the internet I see 2 ms (“cummingiana”) in other sources
>> This one is C. dentata cummingiana (with two "m"s)

```{julia}
#let's manually add "dentata subsp. cumingiana" to synonyms to cover our bases
push!(synonymdict["Calceolaria dentata subsp. cummingiana"], ("Calceolaria dentata subsp. cumingiana", "(Witasek) C.Ehrh."))
```

## create synonym dictionary

```{julia}
powosynonyms = lines[1112:end]

# create authority dictionary for valid names
authority_dict = Dict{String, String}()

for block in blocks
    first_line = split(block, "\n")[1]
    name_match = match(pat, first_line)
    
    if name_match !== nothing
        name = strip(name_match[1])
        name_parts = split(name, " ")
        epithet = length(name_parts) > 2 ? join(name_parts[2:end], " ") : name_parts[2]
        
        authority_match = match(Regex("\\b$(epithet)\\s+(.+?),"), first_line)
        if authority_match !== nothing
            authority = strip(authority_match[1])
            authority = replace(authority, r"\s+in\s+.*$" => "")
            authority_dict[name] = authority
        end
    end
end

# Initialize synonymdict with valid names first
synonymdict = Dict{String, Vector{Tuple{String, Union{String, Missing}}}}()

for name in scientificName
    valid_auth = get(authority_dict, name, missing)
    synonymdict[name] = [(name, valid_auth)]
end

# Add synonyms to the dictionary
synonympat = Regex("^(.+?)\\s+(?=\\(|[A-Z])")

for name in scientificName
    keyname = name
    if name == "Calceolaria corymbosa subsp. montana"
        push!(synonymdict[name], ("Calceolaria mollissima", missing))
        name = "Calceolaria mollissima"
    end

    validnamepat = Regex("=== \\Q$name\\E\\s+(?=\\(|[A-Z])")
    potentialmatches = findall(x -> occursin(validnamepat, x), powosynonyms)
    
    if !isempty(potentialmatches)
        for i in potentialmatches
            line = powosynonyms[i]
            synonym = strip(match(synonympat, line)[1])
            syn_parts = split(synonym, " ")
            syn_epithet = length(syn_parts) > 2 ? join(syn_parts[2:end], " ") : syn_parts[2]
            
            auth_match = match(Regex("\\b$(syn_epithet)\\s+(.+?),"), line)
            syn_authority = missing
            if auth_match !== nothing
                syn_authority = strip(auth_match[1])
                syn_authority = replace(syn_authority, r"\s+in\s+.*$" => "")
            end
            
            push!(synonymdict[keyname], (synonym, syn_authority))       
        end
    end
end

# add speciesAuthority column to taxa_traits
taxa_traits.speciesAuthority = [get(authority_dict, name, missing) for name in taxa_traits.scientificName]

# preview synonyms
for k in keys(synonymdict)
    if length(synonymdict[k]) > 1
        @show k synonymdict[k]
    end
end

# save dictionary
save("data/synonymdict.jld2", "synonymdict", synonymdict)
```

write out clean version of df:
```{julia}
CSV.write("data/traits_species_cleaned-2026_02_09.csv", taxa_traits)
```

2. check to see if I have anything like one sample C. filicaulis and another C. filicaulis luxurians --> in which case, do you filter out all the luxurians for the former? what makes sense for niche modeling? how many occurrences do i have for taxa that are at the infraspecific level?

```{julia}
#filter data frame for matches at specificEpithet
gdf = groupby(taxa_traits, :specificEpithet)
duplicated_specifictaxa = filter(g -> nrow(g) > 1, gdf) |> DataFrame
ismissing(duplicated_specifictaxa) #false
```

No, we don't have any instances of this. good!