---
title: "clean_taxonomy"
output: html_document
date: "2026-02-04"
---

# clean taxonomy: pull taxa names & build dict of synonyms

## load packages

```{julia}
using CSV, DataFrames
```

## load in data

We're only focusing on clade 1 (south) + 2b (central-northish), so let's filter down to that clade.

```{julia}
taxa_traits = DataFrame(CSV.File("data/SupTable4-TraitsSpecies.csv"))
#clean up column names - change from all caps to lowercase
rename!(taxa_traits, lowercase.(names(taxa_traits)))
#remove spaces
rename!(taxa_traits, replace.(names(taxa_traits), ' '=> '_'))
filter!(:clade => x -> x == "1" || x == "2b", taxa_traits)
```

```{julia}
rename!(taxa_traits, Dict(:species => "scientificName"))
scientificName = replace.(taxa_traits.scientificName, "C. " => "Calceolaria ")
taxa_traits.scientificName = scientificName
#make a specificEpithet col
specificEpithet      = [split(taxa, " ")[2] for taxa in scientificName]
#make an infraspecificEpithet col (splitting on var. or subsp.)
infraspecificEpithet = Vector{Union{String,Missing}}()
for taxa in scientificName
    parts = split(taxa, " ")
    if length(parts) >= 4
        push!(infraspecificEpithet, parts[4])
    else
        push!(infraspecificEpithet, missing)
    end?
end

insertcols!(taxa_traits, 2, :specificEpithet => specificEpithet)
insertcols!(taxa_traits, 3, :infraspecificEpithet => infraspecificEpithet)
```

let's initialize dictionary of valid names to synonyms for just the taxa we want:

```{julia}
synonymdict = Dict{String, Vector}()
for taxa in scientificName
    synonymdict[taxa] = [taxa]
end
```

## load in powo checklist

I ran a Kew / Plants of the World Online checklist for Calceolaria species at the botanical country level
on 2026-02-04, using native/introduced taxa.

```{julia}
lines = readlines("data/powochecklist.txt")
#pull lines starting from valid species (skipping headers)
subset = lines[9:1110]
#join back into a single string
text = join(subset, "\n")
#split on one or more empty lines
blocks = split(text, r"\n\s*\n+")
```

### compare names from anahí with powo valid names

```{julia}
#define regex pattern just to pull full name before species authority
pat = Regex(
    "^(.+?)\\s+(?=\\(|[A-Z])",
    "m"
)

validnames = String[]
#grab valid names and add to this vector
for block in blocks
    push!(validnames, strip(match(pat, block)[1]))
end

discrepancies = String[]
for name in scientificName
    if name ∉ validnames
        push!(discrepancies, name)
    end
end

discrepancies
```

fixit: deal with these discrepancies

1.  "Calceolaria dentata subsp. cummingiana” —> Kew has one m in “cumingiana” but on the internet I see 2 ms (“cummingiana”) in other sources
2.  "Calceolaria ascendens subsp. exigua” —> Kew says this is a synonym for "Calceolaria ascendens subsp. glandulifera"
3.  "Calceolaria petiolaris” —> Kew says this is a synonym for “C. petioalaris"
4.  "Calceolaria corymbosa subsp. montana” —> Kew says this is a synonym for "Calceolaria mollissima"
5.  "Calceolaria crenatifolia”  —> Kew doesn’t have anything for “crenatifolia”, but they do have “crenatiflora” accepted
6.  "Calceolaria corymbosa subsp. santiagana” —> I think you have a typo, should be "santiagina"

### add synonyms to dictionary

```{julia}
powosynonyms = lines[1112:end]

for name in scientificName
    #fixit: deal with discrepancy taxa eventually
    if name ∉ discrepancies
        pat = Regex("^\\Q$name\\E\\s+(?=\\(|[A-Z])")
        potentialmatches = findall( x -> occursin(pat, x), powosynonyms)
        if !isempty(potentialmatches)
            for i in potentialmatches
                line = powosynonyms[i]
                synonym = split(line, "=== ")[2]
                #fixit: remove species authority from end of synonym, if applicable
                push!(synonymdict[name], (synonym) )       
            end
        end
    end
end
```

check this worked:
look at dictionary values with synonyms (list length > 1)
```{julia}
for k in keys(synonymdict)
    if length(synonymdict[k]) > 1
        @show k synonymdict[k]
    end
end
```

fixits:
0. deal with discrepancy taxa (if statement on line 113)
1. line 121, removing species authority from synonyms (maybe?, see next point)
2. edge case like Calceolaria heterophylla --> two definitions, one valid one not. The one not is a synonym for a different taxon.